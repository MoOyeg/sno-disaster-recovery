---
# Validate authentication method is available
- name: Check if kubeconfig file exists
  ansible.builtin.stat:
    path: "{{ item }}"
  register: kubeconfig_check
  delegate_to: localhost
  loop:
    - "{{ lookup('env', 'KUBECONFIG') | default('', true) }}"
    - "{{ lookup('env', 'HOME') }}/.kube/config"
    - "{{ playbook_dir }}/kubeconfig"
  when: item != ''

- name: Set kubeconfig path from discovered file
  ansible.builtin.set_fact:
    openshift_kubeconfig: "{{ item.stat.path }}"
    openshift_use_kubeconfig: true
  loop: "{{ kubeconfig_check.results }}"
  when:
    - kubeconfig_check.results is defined
    - item.stat is defined
    - item.stat.exists | default(false)
  loop_control:
    label: "{{ item.stat.path | default('N/A') }}"

- name: Check if using kubeconfig authentication
  ansible.builtin.set_fact:
    using_kubeconfig: "{{ openshift_use_kubeconfig | bool }}"

- name: Display authentication method
  ansible.builtin.debug:
    msg: "Using {{ 'kubeconfig' if using_kubeconfig else 'token' }} authentication"

- name: Fail if neither kubeconfig nor token is available
  ansible.builtin.fail:
    msg: |
      No authentication method found!
      
      Please use one of the following:
      
      Option 1 - Kubeconfig (recommended):
        export KUBECONFIG=~/.kube/config
        # OR place kubeconfig at ./kubeconfig
      
      Option 2 - Token:
        export OPENSHIFT_TOKEN=$(oc whoami -t)
      
      Then run the playbook again.
  when:
    - not using_kubeconfig
    - openshift_token == ''

- name: Set common k8s module parameters (kubeconfig)
  ansible.builtin.set_fact:
    k8s_auth_params:
      kubeconfig: "{{ openshift_kubeconfig }}"
      validate_certs: "{{ openshift_validate_certs }}"
  when: using_kubeconfig

- name: Set common k8s module parameters (token)
  ansible.builtin.set_fact:
    k8s_auth_params:
      host: "{{ openshift_api_url }}"
      api_key: "{{ openshift_token }}"
      validate_certs: "{{ openshift_validate_certs }}"
  when: not using_kubeconfig
