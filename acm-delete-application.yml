---
- name: Delete Quarkus MySQL Application from ACM and ArgoCD
  hosts: localhost
  connection: local
  gather_facts: false
  
  vars:
    acm_namespace: "open-cluster-management"
    application_namespace: "quarkus-web-app"
    gitops_rbac_namespace: "gitops-rbac-policies"
  
  tasks:
    - name: Setup authentication parameters for hub cluster
      ansible.builtin.include_role:
        name: sno_prerequisites
        tasks_from: auth_check
    
    - name: Get all managed clusters
      kubernetes.core.k8s_info:
        api_version: cluster.open-cluster-management.io/v1
        kind: ManagedCluster
      args: "{{ k8s_auth_params }}"
      register: managed_clusters
      ignore_errors: true
    
    - name: Filter SNO clusters (exclude hub)
      ansible.builtin.set_fact:
        sno_cluster_list: "{{ managed_clusters.resources | selectattr('metadata.name', '!=', 'local-cluster') | map(attribute='metadata.name') | list }}"
      when: managed_clusters.resources is defined
    
    - name: Check if kubeconfig files exist for SNO clusters
      ansible.builtin.stat:
        path: "{{ playbook_dir }}/artifacts/{{ item }}/kubeconfig"
      register: kubeconfig_files
      loop: "{{ sno_cluster_list | default([]) }}"
      ignore_errors: true
    
    - name: Display deletion plan
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "APPLICATION DELETION PLAN"
          - "=========================================="
          - "This will delete:"
          - ""
          - "Hub Cluster Resources:"
          - "  - ApplicationSets (quarkus-mysql-appset, volsync-replicationdestination-appset)"
          - "  - Placements (sno-app-placement, sno-app-placement-active, sno-app-placement-standby)"
          - "  - ManagedClusterSetBinding (sno-demo) in openshift-gitops"
          - "  - Role and RoleBinding for GitOps in openshift-gitops"
          - ""
          - "  - Policy (gitops-app-namespace-rbac) in {{ gitops_rbac_namespace }}"
          - "  - Policy (volsync-rsync-tls-secret) in {{ gitops_rbac_namespace }}"
          - "  - PlacementBindings for GitOps RBAC and VolSync Secret"
          - "  - Placement (sno-gitops-rbac-placement) in {{ gitops_rbac_namespace }}"
          - "  - ManagedClusterSetBinding (sno-demo) in {{ gitops_rbac_namespace }}"
          - "  - Namespace ({{ gitops_rbac_namespace }})"
          - ""
          - "SNO Cluster Resources (if kubeconfig available):"
          - "  - ReplicationSource (mysql-replicationsource) on active cluster"
          - "  - Application workloads deployed by ArgoCD"
          - ""
          - "Cluster Labels:"
          - "  - Remove cluster-type and app-role labels from all SNO clusters"
          - "=========================================="
    
    - name: Confirm deletion
      ansible.builtin.pause:
        prompt: |
          
          Are you sure you want to delete the application? (yes/no)
      register: delete_confirm
    
    - name: Fail if deletion not confirmed
      ansible.builtin.fail:
        msg: "Application deletion cancelled by user"
      when: delete_confirm.user_input | lower not in ['yes', 'y']
    
    - name: Delete ReplicationSource from active cluster (if kubeconfig available)
      kubernetes.core.k8s:
        api_version: volsync.backube/v1alpha1
        kind: ReplicationSource
        name: mysql-replicationsource
        namespace: "{{ application_namespace }}"
        state: absent
        kubeconfig: "{{ playbook_dir }}/artifacts/{{ item.item }}/kubeconfig"
      loop: "{{ kubeconfig_files.results }}"
      when:
        - item.stat.exists | default(false)
        - managed_clusters.resources | selectattr('metadata.name', 'equalto', item.item) | selectattr('metadata.labels.app-role', 'defined') | selectattr('metadata.labels.app-role', 'equalto', 'active') | list | length > 0
      loop_control:
        label: "{{ item.item }}"
      ignore_errors: true
    
    - name: Delete ApplicationSet for Quarkus MySQL App
      kubernetes.core.k8s:
        api_version: argoproj.io/v1alpha1
        kind: ApplicationSet
        name: quarkus-mysql-appset
        namespace: openshift-gitops
        state: absent
      args: "{{ k8s_auth_params }}"
      ignore_errors: true
    
    - name: Delete ApplicationSet for VolSync ReplicationDestination
      kubernetes.core.k8s:
        api_version: argoproj.io/v1alpha1
        kind: ApplicationSet
        name: volsync-replicationdestination-appset
        namespace: openshift-gitops
        state: absent
      args: "{{ k8s_auth_params }}"
      ignore_errors: true
    
    - name: Wait for ApplicationSets deletion
      kubernetes.core.k8s_info:
        api_version: argoproj.io/v1alpha1
        kind: ApplicationSet
        name: "{{ item }}"
        namespace: openshift-gitops
      args: "{{ k8s_auth_params }}"
      register: appset_check
      until: appset_check.resources | length == 0
      retries: 30
      delay: 2
      loop:
        - quarkus-mysql-appset
        - volsync-replicationdestination-appset
      ignore_errors: true
    
    - name: Delete Placement for standby SNO clusters
      kubernetes.core.k8s:
        api_version: cluster.open-cluster-management.io/v1beta1
        kind: Placement
        name: sno-app-placement-standby
        namespace: openshift-gitops
        state: absent
      args: "{{ k8s_auth_params }}"
      ignore_errors: true
    
    - name: Delete Placement for active SNO cluster
      kubernetes.core.k8s:
        api_version: cluster.open-cluster-management.io/v1beta1
        kind: Placement
        name: sno-app-placement-active
        namespace: openshift-gitops
        state: absent
      args: "{{ k8s_auth_params }}"
      ignore_errors: true
    
    - name: Delete Placement for all SNO clusters
      kubernetes.core.k8s:
        api_version: cluster.open-cluster-management.io/v1beta1
        kind: Placement
        name: sno-app-placement
        namespace: openshift-gitops
        state: absent
      args: "{{ k8s_auth_params }}"
      ignore_errors: true
    
    - name: Delete Role for PlacementDecision reading
      kubernetes.core.k8s:
        api_version: rbac.authorization.k8s.io/v1
        kind: Role
        name: read-placementdecisions
        namespace: openshift-gitops
        state: absent
      args: "{{ k8s_auth_params }}"
      ignore_errors: true
    
    - name: Delete RoleBinding for GitOps service account
      kubernetes.core.k8s:
        api_version: rbac.authorization.k8s.io/v1
        kind: RoleBinding
        name: gitops-read-placementdecisions
        namespace: openshift-gitops
        state: absent
      args: "{{ k8s_auth_params }}"
      ignore_errors: true
    
    - name: Delete ManagedClusterSetBinding from openshift-gitops
      kubernetes.core.k8s:
        api_version: cluster.open-cluster-management.io/v1beta2
        kind: ManagedClusterSetBinding
        name: sno-demo
        namespace: openshift-gitops
        state: absent
      args: "{{ k8s_auth_params }}"
      ignore_errors: true
    
    - name: Delete PlacementBinding for VolSync Secret Policy
      kubernetes.core.k8s:
        api_version: policy.open-cluster-management.io/v1
        kind: PlacementBinding
        name: volsync-rsync-tls-secret-binding
        namespace: "{{ gitops_rbac_namespace }}"
        state: absent
      args: "{{ k8s_auth_params }}"
      ignore_errors: true
    
    - name: Delete PlacementBinding for GitOps RBAC Policy
      kubernetes.core.k8s:
        api_version: policy.open-cluster-management.io/v1
        kind: PlacementBinding
        name: gitops-app-namespace-rbac-placement-binding
        namespace: "{{ gitops_rbac_namespace }}"
        state: absent
      args: "{{ k8s_auth_params }}"
      ignore_errors: true
    
    - name: Delete Policy for VolSync rsync-tls Secret
      kubernetes.core.k8s:
        api_version: policy.open-cluster-management.io/v1
        kind: Policy
        name: volsync-rsync-tls-secret
        namespace: "{{ gitops_rbac_namespace }}"
        state: absent
      args: "{{ k8s_auth_params }}"
      ignore_errors: true
    
    - name: Delete Policy for GitOps RBAC
      kubernetes.core.k8s:
        api_version: policy.open-cluster-management.io/v1
        kind: Policy
        name: gitops-app-namespace-rbac
        namespace: "{{ gitops_rbac_namespace }}"
        state: absent
      args: "{{ k8s_auth_params }}"
      ignore_errors: true
    
    - name: Wait for Policies deletion
      kubernetes.core.k8s_info:
        api_version: policy.open-cluster-management.io/v1
        kind: Policy
        name: "{{ item }}"
        namespace: "{{ gitops_rbac_namespace }}"
      args: "{{ k8s_auth_params }}"
      register: policy_check
      until: policy_check.resources | length == 0
      retries: 30
      delay: 2
      loop:
        - gitops-app-namespace-rbac
        - volsync-rsync-tls-secret
      ignore_errors: true
    
    - name: Delete Placement for SNO clusters (RBAC)
      kubernetes.core.k8s:
        api_version: cluster.open-cluster-management.io/v1beta1
        kind: Placement
        name: sno-gitops-rbac-placement
        namespace: "{{ gitops_rbac_namespace }}"
        state: absent
      args: "{{ k8s_auth_params }}"
      ignore_errors: true
    
    - name: Delete ManagedClusterSetBinding from gitops-rbac-policies namespace
      kubernetes.core.k8s:
        api_version: cluster.open-cluster-management.io/v1beta2
        kind: ManagedClusterSetBinding
        name: sno-demo
        namespace: "{{ gitops_rbac_namespace }}"
        state: absent
      args: "{{ k8s_auth_params }}"
      ignore_errors: true
    
    - name: Delete gitops-rbac-policies namespace
      kubernetes.core.k8s:
        api_version: v1
        kind: Namespace
        name: "{{ gitops_rbac_namespace }}"
        state: absent
      args: "{{ k8s_auth_params }}"
      ignore_errors: true
    
    - name: Wait for gitops-rbac-policies namespace deletion
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Namespace
        name: "{{ gitops_rbac_namespace }}"
      args: "{{ k8s_auth_params }}"
      register: rbac_ns_check
      until: rbac_ns_check.resources | length == 0
      retries: 60
      delay: 5
      ignore_errors: true
    
    - name: Get all managed clusters with app labels
      kubernetes.core.k8s_info:
        api_version: cluster.open-cluster-management.io/v1
        kind: ManagedCluster
        label_selectors:
          - cluster-type=sno
      args: "{{ k8s_auth_params }}"
      register: labeled_clusters
      ignore_errors: true
    
    - name: Remove app-role label from clusters
      kubernetes.core.k8s:
        api_version: cluster.open-cluster-management.io/v1
        kind: ManagedCluster
        name: "{{ item.metadata.name }}"
        state: patched
        definition:
          metadata:
            labels:
              app-role: null
      args: "{{ k8s_auth_params }}"
      loop: "{{ labeled_clusters.resources }}"
      when: labeled_clusters.resources is defined and labeled_clusters.resources | length > 0
      ignore_errors: true
    
    - name: Remove cluster-type label from clusters
      kubernetes.core.k8s:
        api_version: cluster.open-cluster-management.io/v1
        kind: ManagedCluster
        name: "{{ item.metadata.name }}"
        state: patched
        definition:
          metadata:
            labels:
              cluster-type: null
      args: "{{ k8s_auth_params }}"
      loop: "{{ labeled_clusters.resources }}"
      when: labeled_clusters.resources is defined and labeled_clusters.resources | length > 0
      ignore_errors: true
    
    - name: Display deletion summary
      ansible.builtin.debug:
        msg:
          - "=========================================="
          - "APPLICATION DELETION COMPLETE"
          - "=========================================="
          - "Deleted Resources:"
          - ""
          - "Hub Cluster (ACM Hub):"
          - "  ✓ ApplicationSets removed"
          - "  ✓ Placements removed"
          - "  ✓ ManagedClusterSetBindings removed"
          - "  ✓ RBAC resources removed"
          - "  ✓ GitOps RBAC Policy removed"
          - "  ✓ Namespace '{{ gitops_rbac_namespace }}' removed"
          - ""
          - "SNO Clusters:"
          - "  ✓ Cluster labels (cluster-type, app-role) removed"
          - "  ✓ ReplicationSource removed (if kubeconfig available)"
          - "  ✓ Application workloads cleaned up by ArgoCD"
          - ""
          - "Note: ArgoCD will automatically clean up deployed"
          - "applications on SNO clusters due to ApplicationSet deletion"
          - "=========================================="
